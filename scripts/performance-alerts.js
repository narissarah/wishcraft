#!/usr/bin/env node
// Performance alerting script

import { performanceAnalytics, performanceAlerting } from '../app/lib/performance-dashboard.server.js';

async function checkAlerts() {
  try {
    console.log('üö® Checking performance alerts...');

    const alerting = new performanceAlerting(performanceAnalytics, {
      webhookUrl: process.env.PERFORMANCE_WEBHOOK_URL,
      slackToken: process.env.SLACK_BOT_TOKEN
    });

    await alerting.checkAndSendAlerts();

    const alerts = await performanceAnalytics.generateAlerts();
    
    if (alerts.length === 0) {
      console.log('‚úÖ No performance alerts detected');
    } else {
      console.log(`‚ö†Ô∏è  Found ${alerts.length} performance alert(s):`);
      
      alerts.forEach(alert => {
        const icon = alert.severity === 'critical' ? 'üî¥' : 
                    alert.severity === 'high' ? 'üü†' : 
                    alert.severity === 'medium' ? 'üü°' : 'üü¢';
        
        console.log(`   ${icon} ${alert.title}`);
        console.log(`      ${alert.message}`);
        if (alert.metric && alert.currentValue !== undefined && alert.threshold !== undefined) {
          console.log(`      Current: ${alert.currentValue} | Threshold: ${alert.threshold}`);
        }
        console.log('');
      });
    }

    // Generate recommendations
    const recommendations = await performanceAnalytics.generateRecommendations();
    if (recommendations.length > 0) {
      console.log('üí° Performance Recommendations:');
      recommendations
        .filter(rec => rec.priority === 'high')
        .forEach(rec => {
          console.log(`   üîß ${rec.title}`);
          console.log(`      ${rec.description}`);
          console.log(`      Impact: ${rec.impact} | Effort: ${rec.effort}`);
          console.log('');
        });
    }

  } catch (error) {
    console.error('‚ùå Failed to check performance alerts:', error);
    process.exit(1);
  }
}

checkAlerts();