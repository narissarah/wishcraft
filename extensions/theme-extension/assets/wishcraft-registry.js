(function(){'use strict';const a={apiPath:'/apps/wishcraft/api',debounceDelay:300};const b={debounce(f,w){let t;return function(...args){clearTimeout(t);t=setTimeout(()=>f.apply(this,args),w)}},async apiCall(e,o={}){try{const r=await fetch(`${a.apiPath}${e}`,{...o,headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest',...o.headers}});return r.ok?await r.json():{error:'Request failed'}}catch(err){return{error:err.message}}},formatMoney(c){return '$'+(c/100).toFixed(2)},showMessage(el,msg,type='info'){el.className=`wishcraft-message ${type}`;el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',3000)}};class RegistryList{constructor(blockId){this.blockId=blockId;this.container=document.querySelector(`[data-block-id="${blockId}"]`);this.itemsContainer=document.getElementById(`registry-items-${blockId}`);this.init()}async init(){await this.loadItems();this.bindEvents()}async loadItems(){const registryId=this.container.dataset.registryId;if(!registryId)return;const result=await b.apiCall(`/registries/${registryId}/items`);if(result.error){this.itemsContainer.innerHTML=`<p class="error">Failed to load registry items</p>`;return}this.renderItems(result.items||[])}renderItems(items){if(!items.length){this.itemsContainer.innerHTML='<p class="empty">No items in this registry yet.</p>';return}this.itemsContainer.innerHTML=items.map(item=>`<div class="registry-item" data-item-id="${item.id}"><img src="${item.image}" alt="${item.title}" loading="lazy"><h3>${item.title}</h3><p class="price">${b.formatMoney(item.price)}</p><button class="purchase-btn" data-product-id="${item.productId}">Purchase Gift</button></div>`).join('')}bindEvents(){this.itemsContainer.addEventListener('click',(e)=>{if(e.target.classList.contains('purchase-btn')){const productId=e.target.dataset.productId;const registryId=e.target.dataset.registryId;this.openGiftModal(productId,registryId)}})}openGiftModal(productId,registryId){let modal=document.querySelector('.gift-modal');if(!modal){modal=this.createGiftModal();document.body.appendChild(modal)}modal.dataset.productId=productId;modal.dataset.registryId=registryId;modal.style.display='flex';const firstInput=modal.querySelector('input, textarea');if(firstInput){firstInput.focus()}}createGiftModal(){const modal=document.createElement('div');modal.className='gift-modal';modal.style.cssText=`position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:10000`;modal.innerHTML=`<div class="gift-modal-content" style="background:white;padding:30px;border-radius:10px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;position:relative"><button class="close-modal" style="position:absolute;top:15px;right:20px;background:none;border:none;font-size:24px;cursor:pointer;color:#666">&times;</button><h2 style="margin-bottom:20px;color:#333">Add Gift Message</h2><form class="gift-form"><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-weight:bold">Gift Message:</label><textarea name="giftMessage" placeholder="Write a personal message for this gift..." style="width:100%;min-height:100px;padding:10px;border:1px solid #ddd;border-radius:5px;font-family:inherit;resize:vertical;box-sizing:border-box" maxlength="2000"></textarea></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-weight:bold">Your Name:</label><input type="text" name="purchaserName" placeholder="Your name (optional)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;font-family:inherit;box-sizing:border-box"/></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-weight:bold">Your Email:</label><input type="email" name="purchaserEmail" placeholder="your.email@example.com (optional)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;font-family:inherit;box-sizing:border-box"/></div><div style="margin-bottom:20px"><label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" name="isAnonymous" style="margin-right:10px"/><span>Give this gift anonymously</span></label></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-weight:bold">Quantity:</label><input type="number" name="quantity" value="1" min="1" style="width:100px;padding:10px;border:1px solid #ddd;border-radius:5px;font-family:inherit;box-sizing:border-box"/></div><div style="display:flex;gap:10px;justify-content:flex-end"><button type="button" class="cancel-btn" style="padding:12px 24px;border:1px solid #ddd;background:white;color:#333;border-radius:5px;cursor:pointer;font-family:inherit">Cancel</button><button type="submit" class="add-to-cart-btn" style="padding:12px 24px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;font-family:inherit;font-weight:bold">Add to Cart</button></div></form></div>`;this.bindModalEvents(modal);return modal}bindModalEvents(modal){const closeBtn=modal.querySelector('.close-modal');const cancelBtn=modal.querySelector('.cancel-btn');closeBtn.addEventListener('click',()=>this.closeModal(modal));cancelBtn.addEventListener('click',()=>this.closeModal(modal));modal.addEventListener('click',(e)=>{if(e.target===modal){this.closeModal(modal)}});const form=modal.querySelector('.gift-form');form.addEventListener('submit',(e)=>{e.preventDefault();this.handleGiftFormSubmit(modal)})}closeModal(modal){modal.style.display='none';const form=modal.querySelector('.gift-form');form.reset()}handleGiftFormSubmit(modal){const form=modal.querySelector('.gift-form');const formData=new FormData(form);const productId=modal.dataset.productId;const registryId=modal.dataset.registryId;const giftOptions={registryId:registryId,giftMessage:formData.get('giftMessage'),purchaserName:formData.get('purchaserName'),purchaserEmail:formData.get('purchaserEmail'),isAnonymous:formData.get('isAnonymous')==='on',quantity:parseInt(formData.get('quantity'))||1};this.closeModal(modal);this.purchaseItem(productId,giftOptions)}async purchaseItem(productId,giftOptions={}){try{const properties={};if(giftOptions.registryId){properties['_registry_id']=giftOptions.registryId}if(giftOptions.giftMessage&&giftOptions.giftMessage.trim()){properties['_gift_message']=giftOptions.giftMessage.trim()}if(giftOptions.purchaserName){properties['_purchaser_name']=giftOptions.purchaserName}if(giftOptions.purchaserEmail){properties['_purchaser_email']=giftOptions.purchaserEmail}if(giftOptions.isAnonymous){properties['_is_anonymous']='true'}const cartItem={id:productId,quantity:giftOptions.quantity||1};if(Object.keys(properties).length>0){cartItem.properties=properties}const response=await fetch('/cart/add.js',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(cartItem)});if(!response.ok){const errorData=await response.json();throw new Error(errorData.message||'Failed to add to cart')}this.showSuccessMessage('Item added to cart with gift message!');setTimeout(()=>{window.location.href='/cart'},1500)}catch(error){console.error('Failed to add to cart:',error);this.showErrorMessage(error.message||'Failed to add to cart')}}showSuccessMessage(message){this.showMessage(message,'success')}showErrorMessage(message){this.showMessage(message,'error')}showMessage(message,type='info'){let notification=document.querySelector('.wishcraft-notification');if(!notification){notification=document.createElement('div');notification.className='wishcraft-notification';notification.style.cssText=`position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:5px;color:white;font-weight:bold;z-index:10000;max-width:300px;box-shadow:0 4px 6px rgba(0,0,0,0.1);transition:all 0.3s ease`;document.body.appendChild(notification)}const colors={success:'#28a745',error:'#dc3545',info:'#17a2b8'};notification.style.backgroundColor=colors[type]||colors.info;notification.textContent=message;notification.style.display='block';setTimeout(()=>{notification.style.display='none'},3000)}}class AddToRegistry{constructor(blockId){this.blockId=blockId;this.container=document.querySelector(`[data-block-id="${blockId}"]`);this.init()}async init(){await this.loadRegistries();this.bindEvents()}async loadRegistries(){const result=await b.apiCall('/registries');if(result.error)return;const select=this.container.querySelector('select');if(!select)return;select.innerHTML=result.registries.map(registry=>`<option value="${registry.id}">${registry.title}</option>`).join('')}bindEvents(){const addBtn=this.container.querySelector('.add-to-registry-btn');if(addBtn){addBtn.addEventListener('click',()=>this.addToRegistry())}}async addToRegistry(){const registryId=this.container.querySelector('select')?.value;const productId=this.container.dataset.productId;if(!registryId||!productId)return;const result=await b.apiCall('/registry-items',{method:'POST',body:JSON.stringify({registryId,productId,quantity:1})});const messageEl=this.container.querySelector('.message');if(messageEl){b.showMessage(messageEl,result.error?'Failed to add item':'Item added to registry!',result.error?'error':'success')}}}window.WishCraftRegistry={initRegistryList(blockId){new RegistryList(blockId)},initAddToRegistry(blockId){new AddToRegistry(blockId)}}})();