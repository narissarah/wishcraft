export default function handler(req, res) {
  try {
    console.log('WishCraft app interface:', req.method, req.url);

    // Simple HTML response to avoid crashes
    const appHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WishCraft - Gift Registry Management</title>
    <script src="https://unpkg.com/@shopify/app-bridge@3/umd/index.js"></script>
    <script src="https://unpkg.com/@shopify/app-bridge-utils@3/umd/index.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f6f6f7; color: #202223; line-height: 1.5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header { background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .title { font-size: 24px; font-weight: 600; margin-bottom: 8px; color: #202223; }
        .subtitle { color: #6d7175; font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .card { 
            background: white; padding: 24px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e1e3e5;
        }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
        .card-desc { color: #6d7175; font-size: 14px; margin-bottom: 16px; }
        .btn {
            background: #008060; color: white; border: none; padding: 12px 24px;
            border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;
            transition: background 0.2s; text-decoration: none; display: inline-block;
        }
        .btn:hover { background: #006b4a; }
        .btn-secondary { background: #f6f6f7; color: #202223; }
        .btn-secondary:hover { background: #e4e5e7; }
        .stats { display: flex; gap: 16px; margin-top: 16px; }
        .stat { text-align: center; }
        .stat-number { font-size: 24px; font-weight: 600; color: #008060; }
        .stat-label { font-size: 12px; color: #6d7175; text-transform: uppercase; }
        .feature-list { list-style: none; }
        .feature-list li { 
            padding: 8px 0; border-bottom: 1px solid #e1e3e5; display: flex; 
            align-items: center; gap: 12px; 
        }
        .feature-list li:last-child { border-bottom: none; }
        .icon { width: 20px; height: 20px; display: inline-block; }
        .status-badge { 
            background: #d1f7c4; color: #008060; padding: 4px 8px; 
            border-radius: 4px; font-size: 12px; font-weight: 500; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üéÅ WishCraft Dashboard</h1>
            <p class="subtitle">Manage your store's gift registries and wishlists</p>
            <span class="status-badge">‚úÖ Connected to Shopify 2025-07 API</span>
        </div>

        <div class="grid">
            <div class="card">
                <h2 class="card-title">üìã Registry Management</h2>
                <p class="card-desc">Create and manage customer gift registries with full product integration.</p>
                <button class="btn" onclick="createRegistry()">Create New Registry</button>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Active Registries</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Items</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">‚ù§Ô∏è Wishlist Features</h2>
                <p class="card-desc">Enable customers to create and share wishlists for any occasion.</p>
                <button class="btn" onclick="manageWishlists()">Manage Wishlists</button>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Wishlists</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Shared</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üõçÔ∏è Customer Activity</h2>
                <p class="card-desc">Track customer engagement with registries and wishlist sharing.</p>
                <button class="btn btn-secondary" onclick="viewAnalytics()">View Analytics</button>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">‚öôÔ∏è App Configuration</h2>
                <p class="card-desc">Configure WishCraft settings for your store's specific needs.</p>
                <ul class="feature-list">
                    <li>
                        <span class="icon">‚úÖ</span>
                        <span>Shopify 2025-07 API Integration</span>
                    </li>
                    <li>
                        <span class="icon">‚úÖ</span>
                        <span>GDPR Compliance Webhooks</span>
                    </li>
                    <li>
                        <span class="icon">‚úÖ</span>
                        <span>Serverless Vercel Deployment</span>
                    </li>
                    <li>
                        <span class="icon">‚úÖ</span>
                        <span>Mobile-Responsive Interface</span>
                    </li>
                </ul>
                <button class="btn btn-secondary" onclick="openSettings()">Open Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Shopify App Bridge
        const AppBridge = window['app-bridge'];
        const createApp = AppBridge.default;
        const { Redirect, Toast } = AppBridge.actions;

        const app = createApp({
            apiKey: 'ac161e228a6b078fcdd3fa14586ded14',
            host: new URLSearchParams(location.search).get('host')
        });

        // App functionality
        async function createRegistry() {
            const title = prompt('Enter registry title:');
            if (!title) return;
            
            const description = prompt('Enter registry description (optional):') || '';
            const eventType = prompt('Event type (wedding/birthday/baby-shower/general):') || 'general';
            
            try {
                const response = await fetch('/api/registry?action=create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shop: getShopFromHost(),
                        title,
                        description,
                        eventType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const toast = Toast.create(app, {
                        message: `Registry "${title}" created successfully!`,
                        duration: 4000
                    });
                    toast.dispatch(Toast.Action.SHOW);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                const toast = Toast.create(app, {
                    message: `Failed to create registry: ${error.message}`,
                    duration: 4000,
                    isError: true
                });
                toast.dispatch(Toast.Action.SHOW);
            }
        }

        function manageWishlists() {
            window.open('/api/registry?action=list&shop=' + getShopFromHost(), '_blank');
        }

        function viewAnalytics() {
            window.open('/api/admin?action=analytics&shop=' + getShopFromHost(), '_blank');
        }

        function openSettings() {
            window.open('/api/admin?action=subscription&shop=' + getShopFromHost(), '_blank');
        }
        
        function getShopFromHost() {
            const host = new URLSearchParams(location.search).get('host');
            if (host) {
                return atob(host).split('/')[0];
            }
            return 'demo-shop';
        }

        console.log('WishCraft app initialized successfully');
    </script>
</body>
</html>`;

    res.setHeader('Content-Type', 'text/html');
    res.setHeader('X-Frame-Options', 'ALLOWALL');
    res.setHeader('Content-Security-Policy', "frame-ancestors 'self' https://*.myshopify.com https://admin.shopify.com");
    res.status(200).send(appHtml);

  } catch (error) {
    console.error('App interface error:', error);
    res.status(500).json({
      success: false,
      error: "App interface failed to load",
      message: error.message,
      timestamp: new Date().toISOString()
    });
  }
}